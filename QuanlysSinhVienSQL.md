### Hi there 👋







CREATE DATABASE BTH5
ON PRIMARY(
	NAME=BTH5data,
	FILENAME='E:\Các khóa học\Thực hành hệ quản trị cơ sở dữ liệu\Bài tập\BTH5data.mdf',
	SIZE=10MB,
	MAXSIZE=UNLIMITED,
	FILEGROWTH=200MB
	)
LOG ON(
	NAME=BTH5log,
	FILENAME='E:\Các khóa học\Thực hành hệ quản trị cơ sở dữ liệu\Bài tập\BTH5log.ldf',
	SIZE=100MB,
	MAXSIZE=UNLIMITED,
	FILEGROWTH=2MB
	)
GO
USE BTH5
GO
CREATE TABLE BANG_KHOA(
	MaKhoa char(4) primary key,
	TenKhoa Nvarchar(30),
	SiSo int
)
go
CREATE TABLE BANG_LOP(
	MaLop varchar(10) primary key,
	TenLop Nvarchar(30),
	GVCN Nvarchar(30),
	MaKhoa Char(4),
	SiSo int,
	Constraint BANG_LOP_BAN_KHOA_FK foreign key (MaKhoa) references BANG_kHOA(MaKhoa)
)
go
CREATE TABLE BANG_SINH_VIEN(
	MaSV varchar(10) primary key,
	HoDem Nvarchar(30),
	Ten Nvarchar(20),
	Phai Bit,
	Ngaysinh Date check( (year(getdate())-year(Ngaysinh))>=18),
	DiaChi Nvarchar(50) DEFAULT 'Bình Dương',
	DienThoai varchar(14) check( LEN(DienThoai) BETWEEN 6 AND 11),
	MaLop varchar(10),
	SoCMND int not null,
	constraint BANG_SINH_VIEN_BANG_LOP_FK foreign key (MaLop) references BANG_LOP(MaLop)
)
go
CREATE TABLE BANG_HOC_PHAN(
	MaHP varchar(10) primary key,
	TenHP Nvarchar(30),
	SoTC int
	)
go
CREATE TABLE BANG_KET_QUA(
	MaSV varchar(10),
	MaHP varchar(10),
	DiemLan1 Float CHECK( DiemLan1 BETWEEN 0 AND 10) DEFAULT '0',
	DiemLan2 Float,
	--constraint BANG_KET_QUA_BANG_SINH_VIEN_FK1 foreign key (MaSV) references BANG_SINH_VIEN(MaSV),
	--Constraint BANG_KET_QUA_BANG_HOC_PHAN_FK2 foreign key (MaHP) references BANG_HOC_PHAN(MaHP)
	)

--Nhập liệu
INSERT INTO BANG_KHOA VALUES ('CNTT',N'Công nghê thông tin',70)
INSERT INTO BANG_KHOA VALUES ('CTXH',N'CônG tác xã hội',50)
INSERT INTO BANG_KHOA VALUES ('DDT',N'Điện-Điện tử',65)
INSERT INTO BANG_KHOA VALUES ('KHTN',N'Khoa học tự nhiên',81)
INSERT INTO BANG_KHOA VALUES ('KT',N'Kinh tế',51)
INSERT INTO BANG_KHOA VALUES ('LLCT',N'Lý luận chính trị',65)
INSERT INTO BANG_KHOA VALUES ('LS',N'Lịch sử',65)
INSERT INTO BANG_KHOA VALUES ('LU',N'Luật',65)
INSERT INTO BANG_KHOA VALUES ('NV',N'Ngữ văn',65)
INSERT INTO BANG_KHOA VALUES ('SP',N'Sư phạm',70)

INSERT INTO BANG_LOP VALUES ('CKT2A',N'Kinh tế 2A',N'Lê Thanh Hùng','KT',45)
INSERT INTO BANG_LOP VALUES ('CTH1A',N'Tin học 1A',N'Nguyễn Văn Minh','CNTT',56)
INSERT INTO BANG_LOP VALUES ('CTH1B',N'Tin học 1B',N'Nguyễn Văn Thắng','CNTT',43)
INSERT INTO BANG_LOP VALUES ('CTH2B',N'Tin học 2B',N'Nguyễn Văn Thắng','CNTT',43)
INSERT INTO BANG_LOP VALUES ('DLS36A',N'Lịch sữ 36A',N'Trần Văn Hải','LS',46)
INSERT INTO BANG_LOP VALUES ('DSP35B',N'Sư pham 35B',N'Nguyễn Hoàng Nhân','SP',50)
INSERT INTO BANG_LOP VALUES ('DTH2B',N'Tin học 2B',N'Nguyễn Văn Tùng','CNTT',40)
INSERT INTO BANG_LOP VALUES ('DTH35A',N'Tin học 35A',N'Hoàng Văn Thạnh','CNTT',45)
INSERT INTO BANG_LOP VALUES ('DTH35B',N'Tin học 35B',N'Hoàng Văn Thạnh','CNTT',45)

INSERT INTO BANG_SINH_VIEN VALUES ('A202',N'Tạ Thành',N'Lâm','False','1996/11/01',N'172 Nguyễn Du',N'0837396190','CKT2A',1)
INSERT INTO BANG_SINH_VIEN VALUES ('A203',N'Hoàng Minh',N'Minh','True','1994/11/22',N'132/12 Lê Lợi',N'0974537298','CKT2A',2)
INSERT INTO BANG_SINH_VIEN VALUES ('A204',N'Lê Thị',N'Hoa','False','1996/03/12',N'98 Võ Văn Kiệt',N'0990789213','CKT2A',3)
INSERT INTO BANG_SINH_VIEN VALUES ('B101',N'Lê Bá',N'Hải','True','1993/12/12',N'12 Trương Định',N'0909081312','CTH1B',4)
INSERT INTO BANG_SINH_VIEN VALUES ('B102',N'Phạm Thị',N'Hoa','False','1993/01/09',N'5 Lê Lai Q1',N'0836129846','CTH1B',5)
INSERT INTO BANG_SINH_VIEN VALUES ('B103',N'Lê Vĩnh Phúc',N'Phúc','True','1995/01/04',N'12 Phan Văn Trị',N'0837396190','CTH1B',6)
INSERT INTO BANG_SINH_VIEN VALUES ('B104',N'Phạm Văn',N'Hùng','True','1994/09/04',N'50 Nguyễn Kiệt',N'0919095413','DLS36A',7)
INSERT INTO BANG_SINH_VIEN VALUES ('B105',N'Nguyễn Thanh',N'Tâm','True','1991/05/07',N'45 Lê Quang Định',N'01689908231','CTH1B',8)
INSERT INTO BANG_SINH_VIEN VALUES ('B201',N'Đỗ',N'Hoàng','True','1996/09/11',N'12 Nguyễn Kiệt',N'01687990912','CTH2B',9)
INSERT INTO BANG_SINH_VIEN VALUES ('B202',N'Trần Thị',N'Dung','False','1994/10/01',N'39/12a Nguyễn Văn Tài',N'0846379823','CTH2B',10)
INSERT INTO BANG_SINH_VIEN VALUES ('B203',N'Lê Văn',N'Lợi','True','1993/01/12',N'145/1A Nguyễn Văn Tài',N'0847387291','DSP35B',11)
INSERT INTO BANG_SINH_VIEN VALUES ('B204',N'Đặng Trung',N'Tiến','True','1995/12/22',N'11/1E Lê Lợi',N'0935729813','DTH2B',12)
INSERT INTO BANG_SINH_VIEN VALUES ('C3501',N'Nguyễn Văn',N'Hùng','True','1995/12/12',N'45 Bạch Đằng',N'0739264830','DTH35A',13)
INSERT INTO BANG_SINH_VIEN VALUES ('C3504',N'Trần Hùng',N'Hùng','True','1990/12/12',N'45 Nguyễn Trãi',N'09907213131','DTH35B',16)
INSERT INTO BANG_SINH_VIEN VALUES ('C3601',N'Nguyễn Hoàng',N'Nam','True','1985/07/12',N'12/A Võ Thị Sáu',N'0937829819','DLS36A',19)

INSERT INTO BANG_HOC_PHAN VALUES ('CTR',N'Chính trị',3)
INSERT INTO BANG_HOC_PHAN VALUES ('JAVA',N'Lập trình java',5)
INSERT INTO BANG_HOC_PHAN VALUES ('NMTH',N'Nhập môn tin học',4)
INSERT INTO BANG_HOC_PHAN VALUES ('PPLT',N'Phương pháp LT',5)
INSERT INTO BANG_HOC_PHAN VALUES ('PTWB',N'Phát triển web',3)
INSERT INTO BANG_HOC_PHAN VALUES ('TRR',N'Toac rời rạc',3)

INSERT INTO BANG_KET_QUA VALUES ('A202','JAVA',4,NULL)
INSERT INTO BANG_KET_QUA VALUES ('A204','JAVA',7,NULL )
INSERT INTO BANG_KET_QUA VALUES ('A204','TRR',6.5,NULL )
INSERT INTO BANG_KET_QUA VALUES ('B101','CTR',3,1)
INSERT INTO BANG_KET_QUA VALUES ('B101','TRR',8,NULL )
INSERT INTO BANG_KET_QUA VALUES ('B102','CTR',9,7)
INSERT INTO BANG_KET_QUA VALUES ('B104','NMTH',8,NULL )
INSERT INTO BANG_KET_QUA VALUES ('B102','PPLT',7,NULL )
INSERT INTO BANG_KET_QUA VALUES ('B102','PTWB',2,3)
INSERT INTO BANG_KET_QUA VALUES ('B102','TRR',9,NULL )
INSERT INTO BANG_KET_QUA VALUES ('B103','PPLT',7,NULL )
INSERT INTO BANG_KET_QUA VALUES ('B103','PTWB',6,NULL )
INSERT INTO BANG_KET_QUA VALUES ('B103','TRR',9,NULL )

--I. TRUY VẤN
/**1. CHO XEM DANH SÁCH SINH VIÊN CÓ TUỔI LỚN HƠN 22.**/
SELECT *
FROM BANG_SINH_VIEN
WHERE (YEAR(GETDATE())-YEAR(Ngaysinh))>22

/**2. TẠO QUERY CHO BIẾT DANH SÁCH SINH VIÊN THI LẠI THEO LỚP, THÔNG TIN BAO GỒM MaLop, TenLop, TSSV_thilan2, nhóm theo MaLop, TenLop.**/
SELECT BANG_LOP.TenLop, BANG_LOP.MaLop, COUNT(BANG_SINH_VIEN.MaSV) AS TONGSINHVIENTHILAI
FROM BANG_SINH_VIEN, BANG_LOP, BANG_KET_QUA
WHERE BANG_KET_QUA.DiemLan2 >0 AND BANG_LOP.MaLop=BANG_SINH_VIEN.MaLop AND BANG_KET_QUA.MaSV=BANG_SINH_VIEN.MaSV
GROUP BY BANG_LOP.TenLop, BANG_LOP.MaLop

/**3. TẠO QUERY CHO BIẾT TỔNG SỐ SINH VIÊN THI LẠI THEO TỪNG HỌC PHẦN, THÔNG TIN BAO GỒM MaHP, TenHP,TSSV_thilan2, nhóm theo MaHP, TenHP.**/
SELECT BANG_HOC_PHAN.MaHP,BANG_HOC_PHAN.TenHP, COUNT(BANG_SINH_VIEN.MaSV) AS TONGSINHVIENTHILAI
FROM BANG_SINH_VIEN, BANG_HOC_PHAN, BANG_KET_QUA
WHERE BANG_KET_QUA.DiemLan2 >0 AND BANG_KET_QUA.MaSV=BANG_SINH_VIEN.MaSV AND BANG_KET_QUA.MaHP=BANG_HOC_PHAN.MaHP
GROUP BY BANG_HOC_PHAN.MaHP, BANG_HOC_PHAN.TenHP

--II. PROCEDURE
/**1. VIẾT THỦ TỤC TÌM KIẾM SINH VIÊN THEO BẤT KỲ THÀNH PHẦN NÀO CỦA TÊN.**/
CREATE PROC USP_T ( @HoDem NVARCHAR(30), @TEN NVARCHAR(20))
AS
BEGIN
	SELECT *
	FROM BANG_SINH_VIEN
	WHERE (BANG_SINH_VIEN.HoDem=@HoDem OR BANG_SINH_VIEN.Ten=@TEN)
END

EXEC USP_T N'', N'Lâm'

/**2. VIẾT THỦ TỤC XUẤT RA THÔNG TIN KẾT QUẢ HỌC TẬP CỦA SINH VIÊN KHI NGƯỜI DÙNG NHẬP MaSV.**/
CREATE PROC USP_X ( @MASV VARCHAR(10))
AS
BEGIN
	SELECT *
	FROM BANG_KET_QUA
	WHERE BANG_KET_QUA.MaSV=@MASV
END

EXEC USP_X'A202'

/**3. VIẾT HÀM THỦ TỤC HIỂN THỊ SỐ SINH VIÊN CỦA 1 KHOA KHI NGƯỜI DÙNG NHẬP MÃ KHOA, NẾU MÃ KHOA CHƯA CÓ THÌ SẼ THÊM MỘT KHOA MỚI VÀO BẢNG KHOA ( CÓ MÃ KHOA LÀ MÃ KHOA VỪA NHẬP VÀO ).**/
CREATE PROC USP_HHH (@MAKHOA CHAR(4))
AS
BEGIN
	IF NOT EXISTS ( SELECT MaKhoa FROM BANG_KHOA WHERE BANG_KHOA.MaKhoa=@MAKHOA)
		BEGIN
			INSERT INTO BANG_KHOA (MaKhoa) VALUES ( @MAKHOA)
		END
	ELSE IF EXISTS ( SELECT MaKhoa FROM BANG_KHOA WHERE BANG_KHOA.MaKhoa=@MAKHOA)
		BEGIN
			SELECT SiSo AS TONGSO
			FROM BANG_KHOA
			WHERE BANG_KHOA.MaKhoa=@MAKHOA
		END
END

EXEC USP_HHH 'SP'

/**4. VIẾT HÀM THÊM MỘT SINH VIÊN MỚI VÀO BẢNG SINH VIÊN.**/
CREATE PROC USP_WW ( @MASV CHAR(6), @HODEM NVARCHAR(30), @TEN NVARCHAR(20), @PHAI BIT, @DIACHI NVARCHAR(30), @DIENTHOAI VARCHAR(10), @CMND INT)
AS
BEGIN
	INSERT INTO BANG_SINH_VIEN ( MaSV, HoDem, Ten, Phai, DiaChi, DienThoai, SoCMND) VALUES ( @MASV, @HODEM, @TEN, @PHAI, @DIACHI, @DIENTHOAI, @CMND)
END

EXEC USP_WW'C36002', N'Nguyễn Văn', N'Tài', '1', N'Quảng Ngãi', '0837396190', 2024801030129

--III. FUNCTION
/**1. VIẾT HÀM TÌM MỘT SINH VIÊN BẤT KỲ KHI NGƯỜI DÙNG NHẬP VÀO MÃ SINH VIÊN.**/
CREATE FUNCTION UFC_T (@MASV VARCHAR(10))
RETURNS TABLE
AS

	RETURN(		SELECT *
				FROM BANG_SINH_VIEN
				WHERE BANG_SINH_VIEN.MaSV=@MASV)

SELECT * FROM [dbo].[UFC_T] ('A202')

/**2. VIẾT HÀM TÍNH SỐ TÍN CHỈ ĐẠT ( diemlan1 >=5 hoặc diemlan2 >=5 ) CỦA SINH VIÊN KHI NGƯỜI DÙNG NHẬP MÃ SINH VIÊN.**/
CREATE FUNCTION UFC_HHHHHHH ( @MASV VARCHAR(10))
RETURNS TABLE
AS
RETURN (	SELECT SUM(BANG_HOC_PHAN.SoTC) AS SOTINCHI
			FROM BANG_KET_QUA, BANG_SINH_VIEN, BANG_HOC_PHAN
			WHERE BANG_KET_QUA.MaHP=BANG_HOC_PHAN.MaHP AND BANG_KET_QUA.MaSV=BANG_SINH_VIEN.MaSV AND BANG_SINH_VIEN.MaSV=@MASV AND (BANG_KET_QUA.DiemLan1 >=5 OR BANG_KET_QUA.DiemLan2 >=5)
		)

SELECT * FROM [dbo].[UFC_HHHHHHH] ('A204')

/**3. VIẾT HÀM TÍNH SỐ TÍN CHỈ ĐẠT ( diemlan1 <5 hoặc diemlan2 NULL HOẶC diemlan1 VÀ diemlan2 ĐỀU NHỎ HƠN 5 ) CỦA SINH VIÊN KHI NGƯỜI DÙNG NHẬP MÃ SINH VIÊN.**/

CREATE FUNCTION UFC_HHHHHHHH2 ( @MASV VARCHAR(10))
RETURNS TABLE
AS
RETURN (	SELECT SUM(BANG_HOC_PHAN.SoTC) AS SOTINCHIKHONGDAT
			FROM BANG_KET_QUA, BANG_SINH_VIEN, BANG_HOC_PHAN
			WHERE BANG_KET_QUA.MaHP=BANG_HOC_PHAN.MaHP AND BANG_KET_QUA.MaSV=BANG_SINH_VIEN.MaSV AND BANG_SINH_VIEN.MaSV=@MASV AND ((DiemLan2 < 5 AND DiemLan1< 5)OR (DiemLan1 < 5 AND DiemLan2=NULL))
			
		)

SELECT * FROM [dbo].[UFC_HHHHHHHH2] ('B102')


--IV. TRIGGER
1
/**1. VIẾT TRIGGER ĐỂ THÊM MỘT SINH VIÊN VÀ BẢNG SINHVIEN, CHỈ ĐƯỢC THÊM SINH VIÊN CÓ TUỔI TỪ 18 TRỞ LÊN.**/
CREATE TRIGGER TG_ADD
ON BANG_SINH_VIEN
FOR INSERT
AS
BEGIN
	IF( SELECT YEAR(GETDATE())-YEAR(NGAYSINH) FROM inserted) < 18
		BEGIN
			PRINT N'TUỔI PHẢI LỚN HƠN 18'
			ROLLBACK TRANSACTION
		END
END

INSERT INTO BANG_SINH_VIEN ( MaSV ,HoDem ,Ten, Phai, Ngaysinh ,DiaChi , DienThoai , MaLop , SoCMND ) VALUES ( 'A70', N'Nguyễn Văn',N'Tài','1', '2002/12/14',N'Quảng Ngãi', '0837396190', 'CTH2B', 1 )


/**2. VIẾT TRIGGER ĐỂ THÊM MỘT SINH VIÊN VÀO BẢNG SINHVIEN SAU ĐÓ IN RA SỈ SỐ LỚP MÀ SINH VIÊN ĐÃ ĐƯỢC THÊM VÀO.**/
CREATE TRIGGER TG_KKOOO
ON BANG_SINH_VIEN
AFTER INSERT
AS
BEGIN
	UPDATE BANG_LOP
	SET SiSo=SiSo+1
	WHERE MaLop in ( SELECT MaLop FROM inserted)
END

INSERT INTO BANG_SINH_VIEN ( MaSV ,HoDem ,Ten, Phai, Ngaysinh ,DiaChi , DienThoai , MaLop , SoCMND ) VALUES ( 'A70', N'Nguyễn Văn',N'Tài','1', '2002/12/14',N'Quảng Ngãi', '0837396190', 'CTH2B', 1 )

/**3.	Viết trigger để cập nhật mã lớp DTH35B thành DTH35A, khi đó tất cả sinh viên lớp DTH35B cũng được cập nhật thành sinh viên lớp DTH35A.**/
CREATE TRIGGER TG_DFVJG
ON BANG_LOP
INSTEAD OF UPDATE
AS
BEGIN
	UPDATE BANG_SINH_VIEN
	SET MaLop='DTH35A'
	WHERE MaLop='DTH35B'
END

UPDATE BANG_LOP
SET MaLop='DTH35A'
WHERE MaLop='DTH35B'

/**4. 	Viết trigger thêm kết quả học tập của sinh viên. Lưu ý nếu mã sinh viên không tồn tại thì không được thêm, chỉ được thêm diem từ 0 – 10, nằm khoảng đó thì không được thêm.**/
CREATE TRIGGER TG_ADDKQQQ
ON BANG_KET_QUA
FOR INSERT
AS
DECLARE @MASV VARCHAR(10)
DECLARE @DIEMLAN1 INT
DECLARE @DIEMLAN2 INT
SELECT @MASV=MaSV, @DIEMLAN1=DiemLan1, @DIEMLAN2=DiemLan2
FROM inserted
BEGIN
	IF EXISTS ( SELECT MaSV FROM BANG_SINH_VIEN WHERE BANG_SINH_VIEN.MaSV= @MASV)
		BEGIN
			IF ((@DIEMLAN1 NOT BETWEEN 0 AND 10) OR ( @DIEMLAN2 NOT BETWEEN 0 AND 10))
				BEGIN
					PRINT N'DIEM PHAI >0 VÀ <10'
					ROLLBACK TRANSACTION
				END
		END
	ELSE IF NOT EXISTS ( SELECT MaSV FROM BANG_SINH_VIEN WHERE BANG_SINH_VIEN.MaSV=@MASV)
		BEGIN
			PRINT N'KHÔNG CÓ MÃ S? SINH VIÊN NÀY'
			ROLLBACK TRANSACTION
		END
END

INSERT INTO BANG_KET_QUA(MaSV, MaHP, DiemLan1, DiemLan2) VALUES ('A202', 'CTR', 7, 8)
INSERT INTO BANG_KET_QUA(MaSV, MaHP, DiemLan1, DiemLan2) VALUES ('A209', 'TRR', 7, 8)

SELECT *
FROM BANG_KET_QUA
WHERE BANG_KET_QUA.MaSV='A202'


















<!--
**TaiNguyen14122002/TaiNguyen14122002** is a ✨ _special_ ✨ repository because its `README.md` (this file) appears on your GitHub profile.

Here are some ideas to get you started:

- 🔭 I’m currently working on ...
- 🌱 I’m currently learning ...
- 👯 I’m looking to collaborate on ...
- 🤔 I’m looking for help with ...
- 💬 Ask me about ...
- 📫 How to reach me: ...
- 😄 Pronouns: ...
- ⚡ Fun fact: ...
-->
